# Hoisting Anticipated Expressions - LLVM Pass

## Overview
This code implements an LLVM pass that hoists anticipated expressions in a function. The pass computes anticipated expressions and hoists these expressions to more efficient locations in the program. The goal is to reduce the code by removing redundant expressions across different execution paths.

## Key Concepts
1. **Anticipated Expressions**: Expressions whose values are used later in the program but can be computed earlier without changing the program's correctness.
2. **Hoisting**: Moving expressions that are computed in one basic block to an earlier block, usually a dominator or the first block where the expression is used.
3. **LLVM Pass**: A transformation or analysis applied to a function in an LLVM-based compiler.

## Algorithm for Computing Anticipated Expressions
Initially, the pass iterates over all basic blocks, computes the hash of the expressions, and stores the corresponding instruction pointers. The sets IN[B], GEN[B], OUT[B], and KILL[B] store the expression hash values corresponding to the instructions.

The pass uses a worklist-based algorithm to compute the anticipated expressions:

- **OUT[B]** = Intersection of **IN[S]** for all successors **S** of basic block **B**.
- **IN[B]** = **GEN[B]** \( **OUT[B]** \ **KILL[B]** ).

Where:

- **GEN[B]**: Set of expressions generated by basic block **B**.
- **KILL[B]**: Set of expressions killed by basic block **B** (i.e., expressions whose values are redefined).
- **IN[B]**: Set of expressions anticipated to be available when reaching basic block **B**.
- **OUT[B]**: Set of expressions that are anticipated to be available after basic block **B**.

The analysis proceeds iteratively until there are no changes to the IN and OUT sets.

## Hoisting Strategy
Once the anticipated expressions are computed:

1. **Hoist Expressions**: The pass identifies expressions from the **OUT** sets and moves them to earlier blocks in the control flow graph where they can be reused.
2. **Redundant Expression Removal**: Expressions that are redundant (i.e., expressions that have been hoisted to a dominating block) are eliminated from other blocks.

The pass constructs a dominator tree, extracts a reverse post-order traversal of the dominator tree, and uses the **OUT** set from the current node to eliminate all redundant expressions. After hoisting anticipated expressions, new anticipated expressions may be introduced, so the algorithm runs iteratively until no anticipated expressions remain in the function.

## Structure of the Code

### Header File: `HoistAnticipatedExpressions.h`
This file defines the public interface for the pass, including the main pass class `HoistAnticipatedExpressions`, which inherits from `PassInfoMixin`. The following methods are defined:

- **`run`**: The main method that runs the pass over the function.
- **`computeAnticipatedExpressions`**: Computes the anticipated expressions using the **GEN**, **KILL**, **IN**, and **OUT** sets.
- **`hoistExpressions`**: Hoists the anticipated expressions to appropriate places in the function.

### CPP File: `HoistAnticipatedExpressions.cpp`
This file implements the logic for the pass:

- **Anticipated Expression Calculation**: The function `computeAnticipatedExpressions` calculates the **GEN**, **KILL**, **IN**, and **OUT** sets for each basic block using the worklist algorithm.
- **Expression Hoisting**: The function `hoistExpressions` moves expressions identified in the **OUT** sets to earlier positions in the function, ensuring minimal redundancy and improving performance.
- **Post-order Traversal**: The function `getPostOrderTraversal` computes the post-order of the basic blocks using the dominator tree, which helps in efficiently hoisting expressions. A reverse post-order traversal is then computed from this order.

### Helper Functions

- **`isExpression`**: Checks if an instruction is an expression (i.e., a binary operator, cast, or call instruction).
- **`areOperandsDefinedBefore`**: Checks if any operand of an instruction is defined earlier in the basic block.
- **`hashExpression`**: Computes a hash value for an expression, allowing it to be tracked and identified uniquely across basic blocks.

## Compilation and Usage

### Clone the LLVM Project Repository
```sh
git clone https://github.com/llvm/llvm-project.git
cd llvm-project
git checkout llvmorg-19.1.7
```

### Build LLVM
```sh
mkdir build
cd build
cmake -G "Ninja" -DCMAKE_BUILD_TYPE=Debug \
      -DLLVM_ENABLE_PROJECTS="clang;llvm" -DCMAKE_INSTALL_PREFIX=~/llvm-install \
      ../llvm
ninja
ninja install
```

### Run the Pass
```sh
bin/opt < ../../test/test.ll -passes=hoist-anticipated-expressions -S | FileCheck ../../test/test.ll
```

---
[LLVM Project Repository](https://github.com/llvm/llvm-project.git)

